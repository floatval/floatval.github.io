---
title: VPS 网络防护
date: 2020-03-22 20:05:05
categories: 
 - Linux
tags:
 - SSH
 - 密钥登陆
copyright: true
author: 佚
---

# VPS 安全防护的原因
VPS 因为具有公网 IP，且大多数私人用的 VPS 没有很好的管理习惯。所以有很多的人，在网上对暴露在公网上的 VPS 进行扫描，暴力 SSH 破解。进而实现包括但不限于：以 VPS 作为肉鸡、单纯的破坏 VPS、窃取 VPS 中的信息、挖矿 等目的。

为了更好的保护 VPS 的资源，避免 VPS 被别人用作其他用途，对 VPS 进行一定程度的安全防护设置是非常必要的。

# VPS 防护的手段
VPS 防护的手段常见方式不外乎两种：
0x00. 设置防火墙
- 过滤恶意流量，防止服务器被爆破。
       
0x01. 私钥登陆
- 更改 SSH 默认端口，防止 SSH 暴力破解
- 设置私钥登陆，并禁止使用密码和 root 账号登陆
<!-- more -->

# 设置防火墙
PS: 下面以 Debian 系列进行说明。
设置防火墙屏蔽不必要的端口，可以屏蔽绝大多数的恶意流量。大大的加强 VPS 的安全性。

## 安装配置 ufw 防火墙工具
0x00. `su`

0x01. `sudo apt install ufw`

0x02. `systemctl enable ufw`
       命令解释：开启 ufw 的自动启动。这样不用在每次开关机后，再次手动重启 ufw 的服务。
       
0x03. `systemctl start ufw` 
       命令解释：开启 ufw

0x04. `ufw status`
       命令解释：查看当前 ufw 的状态
       
0x05. `ufw allow ssh`
      命令解释：允许 ssh 协议流量通过防火墙，并开放默认的 ssh 端口（22）

0x06. `ufw status`
       命令解释：查看 ssh 规则是否添加成功。
       
PS：ufw 有很多设置方式：比如可以直接指定要开发的端口 ufw allow 端口号，可以指定协议等。详细请参考 man ufw

### 小结
现在防火墙已经打开，所有访问非 22 端口的流量，或则以非 ssh 协议访问 22 端口的流量，均会被防火墙自动拦截。这样就可以过滤绝大部分的恶意流量了。
但是还是无法方式 SSH 暴力破解，这一让人头疼的问题。防止 SSH 暴力破解的方案，放在下面的 证书登陆中了。

# 私钥登陆
原理：简单来说就是一句话：`非对称加密的密钥具有一对一的特性。一个公钥，加密后的内容，只能被其对应的私钥进行解密`。
而我们在 VPS 上利用证书登陆，就是利用了这一特性。

具体使用分为 3 部分：
    1. 证书的生成
    2. authorized_keys 设置
    3. 相关文件的权限设置
    
## 私钥的生成
注意：VPS 新建用户不推荐加入 sudo 组中，以便做好用户的权限隔离。以下均在要生成密钥的用户下执行。即：要在 A 生成密钥，请切换到 A 用户再去执行下面的命令。

0x00. `mkdir ~/.ssh` 
    命令解释：在自己的家目录下，新建名为 .ssh 的目录。
    
0x01. 执行 `ssh-keygen -t rsa -b 4096 -C "注释信息，便于理解密钥用处，一般为邮件地址`
         - 命令解释：
            ```shell script
                usage: ssh-keygen [-q] [-b bits] [-t dsa | ecdsa | ed25519 | rsa]
                                  [-N new_passphrase] [-C comment] [-f output_keyfile]
            ```
      通过 ssh 的帮助文档中的第一、二行，我们可以清楚的看到 ssh-keygen 常用的参数的含义：
      -t 选项：生成的密钥的类型
      -b 选项：生成的密钥的长度单位为 bit
      -C 选项：生成的密钥的注释信息
      
0x02. `Enter file in which to save the key: ` 选择密钥的存放位置，一般默认即可。可以通过绝对、相对路径来指定。

0x03. `Enter passphrase (empty for no passphrase):` 如果不需要利用密码对生成的密钥进行加密，回车即可。
    PS：如果输入了密码，每次在用密钥进行登陆时，也会要求输入密码，用以解锁加密的密钥。
    
0x04. 下面就是密钥的指纹密码了。可以忽略。

0x05.  `touch ~/.ssh/authorized_keys && cat id_rsa.pub >> authoried_keys` 
        命令解释：在 .ssh 目录下新建 authorized_keys 的文件，并将 id_rsa.pub (上面生成的密钥中的公钥) 添加 authorized_keys 文件
        的末行后。
0x06. `chomod 700 .ssh && chmod 600 .ssh/authorized_keys` 
        命令解释：改变 .ssh 和 authorized_keys 的权限为：700 属主可读写运行，属组和其他用户无权限，600 属主可读写，属组和其他用户无权限
        PS: 这一步不是必须的，但是推荐这么做。可以避免一些权限的问题。
                
0x07. 保存公钥对应的私钥到本地。并在 authorized_keys 文件中，公钥信息的上面以 `#` 开头添加注释信息。推荐：注释信息为对应使用该密钥登陆的用户名

0x08. 在不同的用户中重复执行 0x00-0x04 和 0x06 步骤。0x05 步骤需要部分改变

0x09. 改变后的 0x05 步骤：同样的先执行 0x05 的命令。然后追加 `cat /home/othername/.ssh/authorized_keys >> .ssh/authorized_keys`
      命令解释：将 othername 换为你的其他有密钥的用户的用户名，将其他用户的 authorized_keys 的内容追加到当前的 authorized_keys 中。
      
0x0A. 还有其他用户参考上面同理。

### 设置允许私钥登陆并进行 SSH 配置
0x00. `su`
0x01. `vi /etc/ssh/sshd_config`
-        找到 `AuthorizedKeysFile      .ssh/authorized_keys .ssh/authorized_keys2` 将前面的 `#` 号去掉。
         PS: 如果没解除该句的注释，那么只能用最后一次生成的密钥来登陆最后一个生成密钥的用户。或则，所有用户利用相同的密钥来进行登陆。无法实现不同用户使用不同的密钥来进行登陆。
         原因：参考 ssh 认证中，会从 authorized_keys 中读取存放的公钥信息。来对进行登陆的用户的私钥进行检查。即使你不去设置 authorized_keys 文件，系统仍然会默认在你第一次用密钥登陆时，在该用户的 .ssh 目录下，生成 authorized_keys 文件。
         
0x02. `systemctl restart sshd` 重启 SSH 服务。

0x03. 测试所有用户用密钥登陆: `ssh -i 证书位置 username@ip` 成功后进行下一步，不成功，请确认是否正确完成了上面的所有操作。
- 如果不行，可以用密码登陆 root 用户从头再来。

0x04. 执行 0x01
- 找到 `Port 22` 更改为 `Port 你想用的端口` 推荐大于 1024,因为 1024 及以下的端口 Linux 系统作为保留。一定要小于 65535。
- 执行 0x02
- **切换到 root 用户执行 ufw allow 你想用的端口号**,否则在断开 SSH 连接后，你就登陆不上服务器了。

0x04. 测试所有用户连接: `ssh -p 0x04指定的端口 -i 证书位置 username@ip` 成功后进行下一步，不成功，请确认是否正确完成了上面的所有操作。 
- 如果不行，可以用密码登陆 root 用户从头再来。

0x05. 执行 0x01 
-     找到 `PasswordAuthentication yes` 并将 yes 改为 no。
-     执行 0x02

0x06. 测试所有用户连接: `ssh -p 0x04指定的端口 username@ip` 拒绝密码登陆，成功后进行下一步，不成功，请确认是否正确完成了上面的所有操作。 
- 如果报错 `Permission denied` 则证明成功可以使用 0x04 进行登陆。
- 如果不行，请用密钥登陆 root 用户从头再来。

0x07. 执行 0x01
- 找到 `PermitRootLogin yes` 改为 no 禁止 root 用户登录。在重启 ssh 之前，请将你的 root 密码更改为简单容易记的。以后用密钥登陆服务器，su 的时候要用。
- 执行 0x02
- 原因：防止 SSH 端口被扫描到，别人进行 root 用户包跑（虽然，上面禁止了密码登陆，但是怕有的人觉得禁止密码登陆麻烦，还是留下这一步）。

0x08. 测试 root 用户连接 `ssh -p 0x04指定的端口 root@ip`
- 如果报错 `Permission denied` 则证明成功。可以使用 0x04 登陆。

#### 小结
上面的设置从 SSH 层面做了以下几件事：
1. 更改默认的 SSH 端口，防止暴力 SSH 破解。
2. 更改了 SSH 登陆的方式：从密码登陆 -> 只允许密钥登陆,防止了密码的泄露。
3. 更改了 SSH 登陆的用户限制，只允许非 root 用户登陆,防止了中间人攻击。

而且新建的用户均无 sudo 的权限，这样 VPS 就具有了三层防护。基本可以防止 99% 的恶意攻击了。
另外，不方便更改 SSH 端口的用户，可以参考使用 fail2ban 工具。（有时间的话，单独写一篇教程）

# 总结
VPS 安全防护的第一步：权限的隔离：包括用户权限——普通用户均不在 sudo 组中，文件的权限：登陆的密钥只允许用户的属主使用,防止了单个用户破解，进而导致系统全部暴漏。
VPS 安全防护的第二步：关闭不必要的端口，尽可能减少自己在公网上暴露的信息。即设置防火墙允许自己想要使用的端口，其余端口全部拒绝。
VPS 安全防护的第三步：更改 SSH 配置。以达到只能用非 root 用户，只能利用密钥从指定的端口登陆。最大限度的降低登陆用户遭破解，对系统造成的影响。
